tests:
- name: "cluster name secret is created on installation"
  Release:
    IsInstall: true
  values:
    clusterName: test
  expect: |
    .secrets["helm-effective-cluster-name"] | assertThat(. != null)
    (container(.deployments.sensor; "sensor")).volumeMounts[] | select(.name == "helm-effective-cluster-name") | assertThat(. != null)
    .deployments.sensor.spec.template.spec.volumes[] | select(.name == "helm-effective-cluster-name") | assertThat(. != null)

- name: "cluster name secret is not created on upgrade"
  Release:
    IsInstall: false
    IsUpgrade: true
  expect: |
    .secrets["helm-effective-cluster-name"] | assertThat(. == null)
    .deployments.sensor.spec.template.spec.volumes[] | select(.name == "helm-effective-cluster-name").secret | assertThat(.optional == true)

- name: "cluster name secret is created if confirmNewClusterName matches clusterName"
  values:
    confirmNewClusterName: new-cluster
    clusterName: new-cluster
  Release:
    IsInstall: false
  expect: |
    .secrets["helm-effective-cluster-name"] | assertThat(. != null)
    (container(.deployments.sensor; "sensor")).volumeMounts[] | select(.name == "helm-effective-cluster-name") | assertThat(. != null)
    .deployments.sensor.spec.template.spec.volumes[] | select(.name == "helm-effective-cluster-name") | assertThat(. != null)
